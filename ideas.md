# Предложения по улучшению (универсальный фреймворк обработки мэйлов)

## Критичные
1. Исправить хранение событий: `EventRegistry` сейчас хранит один ключ на правило, что перетирает метаданные при нескольких письмах. Нужен ключ на `event_id` + индексация по правилу.
2. Изменить поведение `patients_info_json`: не отправлять пустые строки, использовать пустой список или не добавлять поле при отсутствии пациентов.
3. Унифицировать нормализацию дат (`date_from`/`date_to`) через `date_helpers` во всех правилах.

## Высокий приоритет
1. Убрать блокировки event loop: заменить синхронный `imaplib` на async (или вынести в отдельный поток/процесс).
2. Заменить Redis `KEYS` на `SCAN` для очистки истёкших событий.
3. Добавить идемпотентность по `Message-ID`/хэшу письма + вложений.
4. Исправить `decode_subject`: декодировать все части `decode_header`, а не только первую.

## Средний приоритет
1. Вынести общий билд `FormData` в helper (sender/subject/original_message/files) — уменьшить дублирование.
2. Сделать единый extractor pipeline: `parse_body -> parse_attachments -> extract_patients -> normalize -> chunk`.
3. Централизовать обработку больших таблиц через `patient_chunker` (chunking после полного парсинга вложений).
4. Стандартизировать извлечение данных из XLS/PDF, сократив уникальные реализации в правилах.

## Архитектура/платформа
1. Ввести единую модель `ProcessedEmail` (body, subject, sender, attachments, patients, metadata).
2. Ввести слой `RequestBuilder`, который превращает модель в `FormData`/JSON.
3. Сделать плагинную архитектуру правил и конфигурацию правил вне кода (YAML/JSON).
4. Абстрагировать транспорт отправки (`OutboundAdapter`) и отправлять все запросы через очередь.
5. Добавить структурные логи и метрики обработки.

# Оценка риска внедрения (1–10)
# Чем выше оценка, тем выше риск сломать текущую логику/API.

## Высокий риск (7–9)
- Плагинная архитектура правил и конфиг вне кода — риск 8/10
- Переход на единый `ProcessedEmail` + `RequestBuilder` — риск 7/10
- Унификация отправки через очередь для всех типов payload — риск 8/10
- Замена синхронного IMAP на async — риск 7/10
- Полная переработка EventRegistry (модель данных + ключи) — риск 7/10

## Средний риск (4–6)
- Введение идемпотентности и дедупа — риск 6/10
- Централизация pipeline и chunking — риск 5/10
- Унификация парсинга XLS/PDF — риск 5/10

## Низкий риск (1–3)
- Исправление `decode_subject` — риск 2/10
- Переход на `SCAN` вместо `KEYS` — риск 2/10
- Удаление пустых полей `patients_info_json` — риск 3/10
- Использование `date_helpers` для нормализации дат — риск 3/10
- Вынесение общего билдера `FormData` — риск 3/10
